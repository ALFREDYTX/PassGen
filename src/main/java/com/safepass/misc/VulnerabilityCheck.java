package com.safepass.misc;

import java.io.IOException;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class VulnerabilityCheck {

    private static final String API_URL = "https://api.pwnedpasswords.com/range/";
    private static final String BREACH_API_URL = "https://haveibeenpwned.com/api/v3/breachedaccount/";
    private HttpClient httpClient;
    private String apiKey = "81f3dac643dd4a60996c9fd6e11847fe";

    public VulnerabilityCheck() {
        this.httpClient = HttpClient.newHttpClient();
    }

    public String getApiKey() {
        return apiKey;
    }

    public void setApiKey(String apiKey) {
        this.apiKey = apiKey;
    }

    public int checkPassword(String password) throws IOException, InterruptedException, NoSuchAlgorithmException {
        String sha1 = sha1(password).toUpperCase();
        String prefix = sha1.substring(0, 5);
        String suffix = sha1.substring(5);

        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(API_URL + prefix))
                .header("User-Agent", "PassGen-App")
                .GET()
                .build();

        HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

        if (response.statusCode() == 200) {
            return parseResponse(response.body(), suffix);
        } else {
            throw new IOException("Error conectando a HIBP: " + response.statusCode());
        }
    }

    public List<BreachInfo> checkEmail(String email) throws IOException, InterruptedException {
        String url = BREACH_API_URL + java.net.URLEncoder.encode(email, "UTF-8") + "?truncateResponse=false";

        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .header("hibp-api-key", this.apiKey)
                .header("User-Agent", "PassGen-App")
                .GET()
                .build();

        HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

        if (response.statusCode() == 200) {
            return parseBreaches(response.body());
        } else if (response.statusCode() == 404) {
            return new ArrayList<>();
        } else if (response.statusCode() == 401) {
            throw new IOException("API Key incorrecta.");
        } else if (response.statusCode() == 429) {
            throw new IOException("Demasiadas peticiones.");
        } else {
            throw new IOException("Error API: " + response.statusCode());
        }
    }

    private List<BreachInfo> parseBreaches(String json) {
        List<BreachInfo> breaches = new ArrayList<>();
        
        if (json.startsWith("[") && json.endsWith("]")) {
            json = json.substring(1, json.length() - 1);
        }
        
        String[] objects = json.split("\\},\\{");
        
        for (String obj : objects) {
            String fullObj = obj;
            if (!fullObj.startsWith("{")) fullObj = "{" + fullObj;
            if (!fullObj.endsWith("}")) fullObj = fullObj + "}";

            BreachInfo info = new BreachInfo();
            info.setName(extractJsonValue(fullObj, "Name"));
            info.setTitle(extractJsonValue(fullObj, "Title"));
            info.setDomain(extractJsonValue(fullObj, "Domain"));
            info.setBreachDate(extractJsonValue(fullObj, "BreachDate"));
            info.setDataClasses(extractJsonArray(fullObj, "DataClasses"));
            breaches.add(info);
        }
        return breaches;
    }

    private String extractJsonValue(String json, String key) {
        Pattern pattern = Pattern.compile("\"" + key + "\":\"(.*?)\"");
        Matcher matcher = pattern.matcher(json);
        if (matcher.find()) {
            return matcher.group(1);
        }
        return "N/A";
    }

    private List<String> extractJsonArray(String json, String key) {
        List<String> result = new ArrayList<>();
        Pattern pattern = Pattern.compile("\"" + key + "\":\\[(.*?)\\]");
        Matcher matcher = pattern.matcher(json);
        if (matcher.find()) {
            String arrayContent = matcher.group(1);
            String[] items = arrayContent.split(",");
            for (String item : items) {
                result.add(item.replace("\"", "").trim());
            }
        }
        return result;
    }

    public static class BreachInfo {
        private String name;
        private String title;
        private String domain;
        private String breachDate;
        private List<String> dataClasses;

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }
        public String getDomain() { return domain; }
        public void setDomain(String domain) { this.domain = domain; }
        public String getBreachDate() { return breachDate; }
        public void setBreachDate(String breachDate) { this.breachDate = breachDate; }
        public List<String> getDataClasses() { return dataClasses; }
        public void setDataClasses(List<String> dataClasses) { this.dataClasses = dataClasses; }

        @Override
        public String toString() {
            return "Sitio: " + title + "\n   Fecha: " + breachDate + "\n   Dominio: " + domain + "\n   Datos: " + dataClasses;
        }
    }

    private int parseResponse(String body, String suffix) {
        Scanner scanner = new Scanner(body);
        while (scanner.hasNextLine()) {
            String line = scanner.nextLine();
            String[] parts = line.split(":");
            if (parts.length == 2) {
                if (parts[0].equals(suffix)) {
                    return Integer.parseInt(parts[1]);
                }
            }
        }
        return 0;
    }

    private String sha1(String input) throws NoSuchAlgorithmException {
        MessageDigest md = MessageDigest.getInstance("SHA-1");
        try {
            byte[] result = md.digest(input.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder();
            for (byte b : result) {
                sb.append(String.format("%02x", b));
            }
            return sb.toString();
        } catch (Exception e) {
            return "";
        }
    }
}
